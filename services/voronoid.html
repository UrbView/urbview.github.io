<style>
    .header {
      background-color:white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 15%;
    }
    
    .header img:first-child {
      margin-left: 10;
    }
    
    .header img:last-child {
      margin-right: 0;
      width: 3%;
      margin-right: 10;
    }
</style>


<html>

<head>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.1.1/papaparse.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
	<link crossorigin="" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
		  integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" rel="stylesheet"/>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script crossorigin=""
			integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
			src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
	<link href="/css/urbstyle.css" rel="stylesheet"/>

	<!-- Load Leaflet library from CDN -->
	<link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet"/>
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<!-- Load D3.js library from CDN -->
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<script src="https://unpkg.com/delaunator@5.0.0/delaunator.min.js"></script>


	<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<script src="https://d3js.org/d3-delaunay.v2.min.js"></script>

	<style>
    
		.row {
		display: flex;
		}

		.column {
		flex: 25%;
		}

		@font-face {
			font-family: urbfont;
			src: url('../style/barlow/barlow/Barlow-Bold.ttf');
			}

			.h2{
			font-family: urbfont;
			}

			@font-face {
			font-family: urbfontlight;
			src: url('../style/barlow/barlow/Barlow-Light.ttf');
			}
			.p{
				font-family: urbfontlight;
		}
    

	</style>

</head>


<body style="background-color: white; font-family: urbfont;">
<a id='last-clicked-coord' style="display: none;"></a>

<div class="header">

	<img src="../style/features/header/logo.png">
	<img src="../style/features/header/profile.png">

</div>

<div class="row">
	<div class="column" style="background-color: whitesmoke">


		<div style="margin-left: 10%;">

			<br>
			<h2 style="font-size: 50;">

				Public Transport Graph

			</h2>

			<div style="width: 90%;">
				<p style="font-family: urbfontlight;">
					<a> Public Transport Graph is a mapping service of Hamburg's bus stops with a safety score assigned to each region, determined by Lunay Triangulation. It enables users to evaluate how the safety score changes with moving between stops.</a>
					<br>
					<br>
					<a style="font-size: smaller;"> Note that UrbView cannot ensure the actual crime rate but can give an idea of how the people in our database would feel given these new urban scenarios.</a>
					<br>
				</p>
			</div>

			<div style="margin: auto; display: flex; gap: 10%;">
				<button>
					<span style="display: block;"> IMPORT </span>
					<img src="../style/Software/City Icons/IO/IODocument/Export_Download Document.svg.png" style="height: 70%; width: 80%">
				</button>
				<button>
					<span style="display: block;"> EXPORT </span>
					<img src="../style/Software/City Icons/IO/Export Icon/exportcolor.png" style="height: 70%; width: 80%">
				</button>
			</div>

		</div>


	</div>
	<div class="column">

		<div id="map" style="height: 620px; width: 100%;"></div>

	</div>

</div>


<script>

	var bus_icon = L.icon({
		iconUrl: '../style/features/public_transport_graph/bus_icon.png',
		iconSize: [28, 28],
		iconAnchor: [14, 14],
		popupAnchor: [0, -28]
	})

	// Hamburg: 53.5488, 9.9874
	var map = L.map('map').setView([53.5488, 9.9874], 11);
	L.tileLayer(
		'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
		{
			maxZoom: 25,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
		}
	).addTo(map);

	function getRandomColor() {
		x = (Math.floor(Math.random() * 2) == 0);
		var a = Math.floor(Math.random() * 255);
		var base = 200;
		if(x){
			var g = 37;
			var r = 193;
			var b = 45;
		}
		else{
			var g = 200;
			var r = 0;
			var b = 72;
		}
		return "rgba(" + r + ", " + g + ", " + b + "," + a + ")"
	}

	function init_map(){
		var map = L.map('map').setView([53.5488, 9.9874], 11);
		L.tileLayer(
			'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
			{
				maxZoom: 25,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			}
		).addTo(map);
	}

	function update_lunay_triangulation(event) { // Listen to 'dragend' event
		// Clear previous triangles
		trianglesLayer.clearLayers();
		// Recompute Delaunay triangulation using updated marker positions
		points = [];
		map.eachLayer(function(layer) {
			if (layer instanceof L.Marker) {
				var latLng = layer.getLatLng();
				points.push([latLng.lat, latLng.lng]);
			}
		});
		delaunay = Delaunator.from(points);
		// Add the new triangles to the map
		var triangles = delaunay.triangles;
		for (var i = 0; i < triangles.length; i += 3) {
			var triangle = [
				points[triangles[i]],
				points[triangles[i + 1]],
				points[triangles[i + 2]]
			];
			L.polygon(triangle, {
				color: getRandomColor(),
				fillOpacity: Math.random()
			}).addTo(trianglesLayer);
		}
	}

	// Create an array of points from the CSV data
	// .csv must have "Name", "Latitude" and "Longitude"
	var points = [];
	var trianglesLayer = L.layerGroup().addTo(map); // Create a layer group for triangles
	$.get('https://raw.githubusercontent.com/UrbView/urbview.github.io/main/data/hamburg_small.csv', function(csvString) {
		Papa.parse(csvString, {
			header: true,
			delimiter: ';',
			dynamicTyping: true,
			complete: function(results) {
				//console.log('Parsed CSV:', results);
				results.data.forEach(function(row) {
					// console.log('Row:', row);
					if ('Latitude' in row) {
						if ('Longitude' in row) {
							var lat = parseFloat(row.Latitude.toString().replace(',', '.'));
							var lng = parseFloat(row.Longitude.toString().replace(',', '.'));
							points.push([lat, lng]);
						}
					}
				});

				// Compute the Delaunay triangulation
				var delaunay = Delaunator.from(points);
				// Create an array of triangles from the triangulation
				var triangles = delaunay.triangles;
				// Add the triangles to the map
				for (var i = 0; i < triangles.length; i += 3) {
					var triangle = [
						points[triangles[i]],
						points[triangles[i + 1]],
						points[triangles[i + 2]]
					];
					console.log(triangle)
					L.polygon(triangle, {
						color: getRandomColor(),
						fillOpacity: Math.random()
					}).addTo(trianglesLayer);
				}
				// Add markers to the map
				results.data.forEach(function(row) {
					if ('Latitude' in row) {
						var lat = parseFloat(row.Latitude.toString().replace(',', '.'));
						var lng = parseFloat(row.Longitude.toString().replace(',', '.'));
						var marker = L.marker([lat, lng], {
							draggable: true,
							icon: bus_icon
						}).addTo(map);
						marker.bindPopup(row.Name);
						marker.on('dragend', update_lunay_triangulation)
					}
				});
			},
			error: function(error) {
				console.log('CSV parsing error:', error);
			}
		});
	});

	var addedPoints = []
	map.on('click', function(event) { // Listen to 'click' event
		// Clear previous triangles
		var ll = event.latlng;
		trianglesLayer.clearLayers();
		// Recompute Delaunay triangulation using updated marker positions
		addedPoints.push([ll.lat, ll.lng])

		var marker = L.marker([ll.lat, ll.lng], {
						draggable: true,
						icon: bus_icon
					}).addTo(map);
		marker.on('dragend', update_lunay_triangulation);
		var points = [];
		map.eachLayer(function(layer) {
			if (layer instanceof L.Marker) {
			var latLng = layer.getLatLng();
			points.push([latLng.lat, latLng.lng]);
			}
		});
		points = points.concat( addedPoints);
		var delaunay = Delaunator.from(points);
		// Add the new triangles to the map
		var triangles = delaunay.triangles;
		for (var i = 0; i < triangles.length; i += 3) {
			var triangle = [      points[triangles[i]],
			points[triangles[i + 1]],
			points[triangles[i + 2]]
			];
			L.polygon(triangle, {
			color: getRandomColor(),
			fillOpacity: Math.random()
			}).addTo(trianglesLayer);
		}
	});
    

</script>

</body>

</html>
    